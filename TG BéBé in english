# How to use Spiec-Easi?

---
titre: "How to use Spiec-Easi?"
autehor: "Paola Fournier" 
date: "21/06/2021"
sortie: htlm_document
---
# How to use Spiec-Easi (Sparse and Compositionally Robust Inference of Microbial Ecological Networks)?

This tutorial is intended for novices who wants to get acquainted with network inference via the Spiec-Easi model (Kurtz et al., 2015). 

Github (: https://github.com/zdk123/SpiecEasi  
doi : https://doi.org/10.1371/journal.pcbi.1004226 

I chose this model because it addresses two major problems of correlation-based models:   

  1)it uses the concept of conditional dependence to avoid the detection of correlated but indirectly connected taxa. Correlation is a pairwise metric and therefore limited in a multivariate framework.
  2)it takes into account the compositionality of the data by applying a "clr" transformation on the input abundance table.
  
## **Some important concepts before embarking on microbial network inference**
### Compositional data
let's speak first about how amplicon sequencing data is generated and why that can be a problem 

**What is a compositional data ?**   
Compositional data is defined as a vector of strictly positive real numbers with an unknown or uninformative total (e.g., sequencing depth) because the abundance of each component carries only relative information (Pawlowsky-Glahn et al., 2015). 

**How are amplicon sequencing data compositional?**
Sequencing machines can only provide reads up to their capacity, and therefore each sample is subjected to an arbitrary constant sum constraint. NGS-derived datasets are therefore compositional in nature. 

**What are the consequences?**
The number of reads per sample is not fully interpretable by itself: the total number of reads assigned to a sample or taxa do not provide any information about the number of DNA molecules in the original samples.   
Only the relative changes can be oberved: samples cannot be directly compared because they have a specific sequencing depth. 
Many statistical methods should not be used because they assume independence between features (e.g., abondance of each taxa in one sample), which is not the case for NGS generated data.   

**Litterature and proposed solutions**
A popular technique for recalculating absolute abundances is to compare the log ratio of counts to a reference species. In this case, the reference species is known to have an approximately stable abundance across populations. These ratios are compared instead of counts directly.      
If such a species is not known or not available, the reference can be replaced by a robust composite measure obtained from various species. One such measure is the geometric mean of all counts in the sample. This method assumes that an aggregate of various species does not change in mass between their original environments. Figure 1 illustrates the application of alr and clr transformation


<img src="https://github.com/paoluxe/How-to-use-SpiecEasi-/blob/5d1ce20694fb1a99d621cc01e3b2f2cb4f884c21/Pictures%20README/log-ratio.PNG">


### Principle of co-occurrence networks    
Co-occurrence networks require as input abundance tables of taxa from multiple samples. When two taxa co-occur or show a similar abundance pattern among multiple samples, a co-occurence is assumed between them. A positive link is shown in green (graph) or a "1" in the adjacency table (see below). Conversely, when these two taxa are mutually exclusive, a co-exclusion is assumed, illustrated by a red link connecting two nodes (graph) or a "-1" in the adjacency table (see below). 
<p align="center">
<img src="https://github.com/paoluxe/How-to-use-SpiecEasi-/blob/ef1049e3acef34d2c039fd7aee9abb8fbc162609/Pictures%20README/Principe%20R%C3%A9seaux%20de%20co-occurrence.PNG" width = "700">
</p>

### How SpiecEasi works (mb method)
Here is described the "mb" method i.e. Meinshausen-Buhlmann neighborhood selection (Meinshausen and Buhlmann, 2006) which is one of the two network inference methods supported by the SpiecEasi function. The "mb" method has shown good results and is fast in comparison with the "glasso" method (Kurtz et al., 2015; Röttjers and Faust, 2018).   

From a table of taxon abundances on multiple samples, it first applies a "clr" transformation to recalculate absolute abundances. The "mb" inference method consists of fitting penalized regressions using each species in turn as the response and all others as predictors.  In this way, the network is inferred from 80% of the samples n times. The model performs these n iterations (inferring the network from a subsample) over a range of values of λ, the parameter that controls the power of the regularization. SpiecEasi thus generates several adjacency tables from the same initial dataset, but from different subsamples, for each lambda value. Through the StARS tool, it selects λ such that the overall stability of the edges across iterations is maximized.The last step is to generate the network with 100% of the data and the optimized λ.

<p align="center">
  <img src="https://github.com/paoluxe/How-to-use-SpiecEasi-/blob/ef1049e3acef34d2c039fd7aee9abb8fbc162609/Pictures%20README/Principe%20SpiecEasi.PNG" width = "800">
</p>

## **I) Downloading the packages**  
SpiecEasi  
```{r eval=FALSE, include=TRUE}
install.packages("devtools")
library(devtools)
install_github("zdk123/SpiecEasi")
```
phyloseq  

```{r eval=FALSE, include=TRUE}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("phyloseq")

```


## **II) Data loading and creation of the phyloseq object**  

SpiecEasi can be used with an OTU abundance matrix containing samples in rows and taxa in columns.
Row names = sample names / column names = taxa names.

A phyloseq object can also be used.

For the uplaod of the data and the creation of the phyloseq object, this tutorial has been creating according to the following link: https://vaulot.github.io/tutorials/Phyloseq_tutorial.html
Form and content of the input matrices : see link above

Import csv data


```{r eval=FALSE, include=TRUE}
## otu_mat = taxon abundance matrix across multiple samples: otu = rows/samples = columns
otu_mat<- read.csv("otu_mat.csv", sep=";", header = T) ; View(otu_mat)

## tax_mat = taxonomy matrix: otu = rows/taxonomy = columns
tax_mat<- read.csv("tax_mat.csv", sep=";", header = T) ; View(tax_mat)

## samples_df = matrix of variables: samples = rows/variables = columns
samples_df <- read.csv("samples_df.csv", sep=";", header = T) ; View(samples_df)
```
The phyloseq objects must have row names

```{r eval=FALSE, include=TRUE}
library(dplyr)
```
otu_mat : the names of the rows become the otu
```{r eval=FALSE, include=TRUE}
otu_mat <- otu_mat %>%
  tibble::column_to_rownames("otu") ## replace "otu" by the name of the column containing the otu/taxons/sp
```
tax_mat : the names of the rows become the otu
```{r eval=FALSE, include=TRUE}
tax_mat <- tax_mat %>% 
  tibble::column_to_rownames("otu")
```
samples_df : the names of the rows become the samples
```{r eval=FALSE, include=TRUE}
samples_df <- samples_df %>% 
  tibble::column_to_rownames("sample") ## replace "sample" by the name of the column containing the samples
```
Transformation of the data.frame into matrices 
```{r eval=FALSE, include=TRUE}
otu_mat <- as.matrix(otu_mat)
tax_mat <- as.matrix(tax_mat)
```
Creation of the phyloseq object
```{r eval=FALSE, include=TRUE}
library(phyloseq)

OTU = otu_table(otu_mat, taxa_are_rows = TRUE)
TAX = tax_table(tax_mat)
samples = sample_data(samples_df)

obj_physeq <- phyloseq(OTU, TAX, samples)
```


## **III )Dataset processing: dataset separation, application of prevalence/abundance filters**
Create groups of samples to be analyzed according to a modality of a variable
```{r eval=FALSE, include=TRUE}
obj_physeq1 <- subset_samples(obj_physeq, nomvariable =="modalite1") ## replace nomvariable and modalite (nomvariable=name of the variable; madalite=name of the modality)
obj_physeq2 <- subset_samples(obj_physeq, nomvariable =="modalite2") ## replace nomvariable and modalite 
```

**Data filtering**
Röttjers and Faust (2018) recommended the application of a prevalence filter on the abundance matrices to avoid the inference of biased associations due to the high number of zeros in the microbial abundance tables and a niche preference effect.

Indeed, in a heterogeneous environment (biotic and abiotic conditions changing between samples) 2 species with growth optima in the same niches will co-occur. The opposite effect will lead to mutual exclusion.

The microbial abundance tables are rich in zeros, but we don't know their significance, is it due to a real absence or an under-sampling?
Correlations/regressions calculated over many matching zeros will be highly significant, even though the taxa involved may vary randomly below the detection limit. 

The filter_taxa function can be used to apply an abundance or prevalence filter or both on the dataset
Here: the taxa are present at least once in 20% of the samples. These choices are completely arbitrary and are given here as an example
We play on the abundance via "sum(x > 0)" and on the prevalence via "(0.2*length(x))".
```{r eval=FALSE, include=TRUE}
obj_physeq1_filtre = filter_taxa(obj_physeq1, function(x) sum(x > 0) > (0.2*length(x)), TRUE)
```
Another way to filter the data that is not arbitrary is to use the MultiCoLA tool. This tool evaluates the impact of different abundance or rarity thresholds on the structure of the resulting dataset.

  Link to the article : https://academic.oup.com/nar/article/38/15/e155/2409766?login=true   
  doi:10.1093/nar/gkq545
   Scripts available here :https://www.mpi-bremen.de/en/Softwares.html#section1550





